---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getEquipment } from "../../data/equipment";
import { getBeans } from "../../data/beans";
import { withBase } from "../../utils/paths";

export async function getStaticPaths() {
  const equipment = await getEquipment();
  return equipment.flatMap((item) => {
    const aliases = item.aliases?.map((alias) => ({ params: { slug: alias.slug } })) ?? [];
    return [{ params: { slug: item.slug } }, ...aliases];
  });
}

const { slug } = Astro.params;
const equipment = await getEquipment();
const beans = await getBeans();
const item =
  equipment.find((entry) => entry.slug === slug) ??
  equipment.find((entry) => entry.aliases?.some((alias) => alias.slug === slug));
const alias = item?.aliases?.find((entry) => entry.slug === slug);
const related = equipment.filter((entry) => item?.related.includes(entry.slug));
const gearSlugs = new Set([item?.slug, ...(item?.aliases?.map((entry) => entry.slug) ?? [])]);
const renderResult = item ? await item.render() : null;
const NotesContent = renderResult?.Content;
const hasNotes = Boolean(item?.body?.trim());
const relatedBeans = beans
  .filter((bean) => {
    const brewerSlug = bean.data.brew?.brewer?.slug;
    const grinderSlug = bean.data.brewDetails?.grinder?.slug;
    const extraGear = bean.data.gear?.map((entry) => entry.slug) ?? [];
    return (
      (brewerSlug && gearSlugs.has(brewerSlug)) ||
      (grinderSlug && gearSlugs.has(grinderSlug)) ||
      extraGear.some((entry) => entry && gearSlugs.has(entry))
    );
  })
  .sort((a, b) => {
    const left = new Date(`${a.data.date}T${a.data.time}:00`);
    const right = new Date(`${b.data.date}T${b.data.time}:00`);
    return right.getTime() - left.getTime();
  });
---
<BaseLayout
  title={`${item?.name ?? "Equipment"} · Beans`}
  description={`Equipment reference for ${item?.name ?? "gear"}.`}
  initialCommand={`$ bean ${item?.type ?? "equipment"} ${item?.slug ?? ""}`.trim()}
>
  <section class="hero">
    <h1>{item?.name}</h1>
    <p>Namespace: {item?.type}</p>
    {alias && <p>Alias: {alias.name}</p>}
    <p>
      <a href={withBase("/equipment/")}>[back to equipment]</a>
    </p>
  </section>
  {item?.image ? (
    <section class="window">
      <h2 class="section-title">Image</h2>
      <figure class="bean-observation-media">
        <img src={withBase(item.image.src)} alt={item.image.alt} loading="lazy" />
      </figure>
    </section>
  ) : null}
  {NotesContent && hasNotes && (
    <section class="window">
      <h2 class="section-title">Notes</h2>
      <div class="markdown">
        <NotesContent />
      </div>
    </section>
  )}
  {item?.aliases?.length > 0 && (
    <section class="window">
      <h2 class="section-title">Aliases</h2>
      <ul>
        {item.aliases.map((entry) => (
          <li>
            <a href={withBase(`/equipment/${entry.slug}/`)}>{entry.name}</a>
          </li>
        ))}
      </ul>
    </section>
  )}
  <section class="window">
    <h2 class="section-title">Recent beans</h2>
    {relatedBeans.length > 0 ? (
      <ul>
        {relatedBeans.map((bean) => (
          <li>
            <a href={withBase(`/log/${bean.slug}/`)}>
              {bean.data.date}
              {bean.data.time ? ` ${bean.data.time}` : ""} · {bean.data.title}
            </a>
          </li>
        ))}
      </ul>
    ) : (
      <p>No beans logged with this gear yet.</p>
    )}
  </section>
  {item?.references?.length > 0 && (
    <section class="window">
      <h2 class="section-title">References</h2>
      <ul>
        {item.references.map((reference) => (
          <li>
            <a href={reference.url}>{reference.label}</a>
          </li>
        ))}
      </ul>
    </section>
  )}
  {related.length > 0 && (
    <section class="window">
      <h2 class="section-title">Related</h2>
      <ul>
        {related.map((entry) => (
          <li>
            <a href={withBase(`/equipment/${entry.slug}/`)}>[{entry.name}]</a>
          </li>
        ))}
      </ul>
    </section>
  )}
</BaseLayout>
