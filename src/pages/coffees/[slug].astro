---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getCoffees } from "../../data/coffees";
import { getRoasters } from "../../data/roasters";
import { getBeans } from "../../data/beans";
import { withBase } from "../../utils/paths";

export async function getStaticPaths() {
  const coffees = await getCoffees();
  return coffees.map((coffee) => ({ params: { slug: coffee.slug } }));
}

const { slug } = Astro.params;
const coffees = await getCoffees();
const coffee = coffees.find((entry) => entry.slug === slug);
const roasters = await getRoasters();
const roaster = roasters.find((entry) => entry.slug === coffee?.roaster);
const beans = await getBeans();
const relatedBeans = beans.filter((bean) => bean.coffee.roast?.slug === slug).slice(0, 3);
const renderResult = coffee ? await coffee.render() : null;
const NotesContent = renderResult?.Content;
const hasNotes = Boolean(coffee?.body?.trim());
---
<BaseLayout
  title={`${coffee?.name ?? "Coffee"} Â· Beans`}
  description={`Coffee profile for ${coffee?.name ?? "roast"}.`}
  initialCommand={`$ bean coffee ${coffee?.slug ?? ""}`.trim()}
>
  <section class="hero">
    <h1>{coffee?.name}</h1>
    {roaster ? (
      <p>
        Roaster: <a href={withBase(`/roasters/${roaster.slug}/`)}>{roaster.name}</a>
      </p>
    ) : null}
    <p>
      <a href={withBase("/coffees/")}>[back to coffees]</a>
    </p>
  </section>
  {coffee?.image ? (
    <section class="window">
      <h2 class="section-title">Image</h2>
      <figure class="bean-observation-media">
        <img src={withBase(coffee.image.src)} alt={coffee.image.alt} loading="lazy" />
      </figure>
    </section>
  ) : null}
  {NotesContent && hasNotes ? (
    <section class="window">
      <h2 class="section-title">Notes</h2>
      <NotesContent />
    </section>
  ) : null}
  <section class="window">
    <h2 class="section-title">Details</h2>
    <table class="cup-table">
      <tbody>
        <tr>
          <th scope="row">ROAST LEVEL</th>
          <td>{coffee?.roastLevel ?? "not recorded"}</td>
        </tr>
        <tr>
          <th scope="row">PROFILE</th>
          <td>{coffee?.profile ?? "not recorded"}</td>
        </tr>
        <tr>
          <th scope="row">BLEND</th>
          <td>{coffee?.blend ?? "not recorded"}</td>
        </tr>
      </tbody>
    </table>
  </section>
  <section class="window">
    <h2 class="section-title">Recent brew logs</h2>
    {relatedBeans.length ? (
      <ul class="table-list">
        {relatedBeans.map((bean) => (
          <li>
            <a href={withBase(`/log/${bean.slug}/`)}>
              [{bean.date} {bean.beanKey}]
            </a>
            {" "}- {bean.title}
          </li>
        ))}
      </ul>
    ) : (
      <p>No recent brew logs yet.</p>
    )}
  </section>
</BaseLayout>
