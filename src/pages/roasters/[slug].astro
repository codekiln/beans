---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getRoasters } from "../../data/roasters";
import { getCoffees } from "../../data/coffees";
import { withBase } from "../../utils/paths";

export async function getStaticPaths() {
  const roasters = await getRoasters();
  return roasters.map((roaster) => ({ params: { slug: roaster.slug } }));
}

const { slug } = Astro.params;
const roasters = await getRoasters();
const roaster = roasters.find((entry) => entry.slug === slug);
const coffees = await getCoffees();
const roasterCoffees = coffees.filter((coffee) => coffee.roaster === slug);
const renderResult = roaster ? await roaster.render() : null;
const NotesContent = renderResult?.Content;
const hasNotes = Boolean(roaster?.body?.trim());
---
<BaseLayout
  title={`${roaster?.name ?? "Roaster"} Â· Beans`}
  description={`Roaster profile for ${roaster?.name ?? "coffee"}.`}
  initialCommand={`$ bean roaster ${roaster?.slug ?? ""}`.trim()}
>
  <section class="hero">
    <h1>{roaster?.name}</h1>
    <p>
      <a href={withBase("/roasters/")}>[back to roasters]</a>
    </p>
  </section>
  {roaster?.image ? (
    <section class="window">
      <h2 class="section-title">Image</h2>
      <figure class="bean-observation-media">
        <img src={withBase(roaster.image.src)} alt={roaster.image.alt} loading="lazy" />
      </figure>
    </section>
  ) : null}
  {NotesContent && hasNotes ? (
    <section class="window">
      <h2 class="section-title">Notes</h2>
      <NotesContent />
    </section>
  ) : null}
  <section class="window">
    <h2 class="section-title">Roasts</h2>
    {roasterCoffees.length ? (
      <ul class="table-list">
        {roasterCoffees.map((coffee) => (
          <li>
            <a href={withBase(`/coffees/${coffee.slug}/`)}>[{coffee.name}]</a>
          </li>
        ))}
      </ul>
    ) : (
      <p>No roasts logged yet.</p>
    )}
  </section>
</BaseLayout>
