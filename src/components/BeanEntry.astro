---
import TagRow from "./TagRow.astro";
import { withBase } from "../utils/paths";

const { bean } = Astro.props;
const logCommand = `log ${bean.date} ${bean.beanKey}`;
const command = `$ bean ${logCommand}`;
const detailHref = withBase(`/log/${bean.slug}/`);
const escapeHtml = (value) =>
  value
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#39;");
const renderInlineMarkdown = (value) => {
  const linkPattern = /\[([^\]]+)\]\((https?:\/\/[^)]+)\)/g;
  let output = "";
  let lastIndex = 0;
  let match;

  while ((match = linkPattern.exec(value)) !== null) {
    output += escapeHtml(value.slice(lastIndex, match.index));
    output += `<a href="${escapeHtml(match[2])}">${escapeHtml(match[1])}</a>`;
    lastIndex = match.index + match[0].length;
  }

  output += escapeHtml(value.slice(lastIndex));
  return output;
};

const coffeeRows = [
  bean.coffee.roaster && {
    label: "roaster",
    value: bean.coffee.roaster.name,
    href: withBase(`/roasters/${bean.coffee.roaster.slug}/`)
  },
  bean.coffee.roast && {
    label: "coffee",
    value: bean.coffee.roast.name,
    href: withBase(`/coffees/${bean.coffee.roast.slug}/`)
  },
  bean.coffee.roastLevel && { label: "roast level", value: bean.coffee.roastLevel },
  bean.coffee.profile && { label: "profile", value: bean.coffee.profile },
  bean.coffee.blend && { label: "blend", value: bean.coffee.blend }
].filter(Boolean);

const grindValue = bean.brewDetails.grind ?? bean.brewDetails.setting;
const brewDetailsRows = [
  bean.brew.recipe && {
    label: "recipe",
    value: bean.brew.recipe.name,
    href: withBase(`/recipes/${bean.brew.recipe.slug}/`)
  },
  bean.brewDetails.dose && { label: "dose", value: bean.brewDetails.dose },
  grindValue && { label: "grind", value: grindValue },
  bean.brewDetails.water && { label: "water", value: bean.brewDetails.water },
  bean.brewDetails.ratio && { label: "ratio", value: bean.brewDetails.ratio },
  bean.brewDetails.temp && { label: "temp", value: bean.brewDetails.temp },
  bean.brewDetails.release && {
    label: "release time",
    value: bean.brewDetails.release,
    definition: "Time when the brew valve is opened or the release step begins."
  },
  bean.brewDetails.total && {
    label: "total brew time",
    value: bean.brewDetails.total,
    definition: "Total time from first pour to the end of drawdown."
  }
].filter(Boolean);

const gearItems = [
  bean.brew.brewer && {
    label: "brewer",
    value: bean.brew.brewer.name,
    slug: bean.brew.brewer.slug
  },
  bean.brewDetails.grinder && {
    label: "grinder",
    value: bean.brewDetails.grinder.name,
    slug: bean.brewDetails.grinder.slug
  },
  ...(bean.gear ?? [])
].filter(Boolean);
---
<article
  class="bean-entry"
  id={bean.slug}
  data-cli={command}
  data-cli-log={logCommand}
  data-cli-href={detailHref}
>
  <div class="ascii-block" aria-hidden="true">
    <pre>{command}</pre>
  </div>
  <div class="bean-grid">
    <div class="bean-main window">
      <header>
        <h2>{`BEAN ${bean.date} / ${bean.time}`}</h2>
        <p class="bean-title">{bean.title}</p>
        <p class="ascii-block" aria-hidden="true">======================</p>
      </header>
      <section>
        <h3 class="section-title">Observations</h3>
        <ul>
          {bean.observations.map((line) => (
            <li set:html={renderInlineMarkdown(line)}></li>
          ))}
        </ul>
        {bean.image && (
          <figure class="bean-observation-media">
            <img src={withBase(bean.image.src)} alt={bean.image.alt} loading="lazy" />
          </figure>
        )}
        <TagRow tags={bean.tags} />
      </section>
      <section>
        <h3 class="section-title">Brew notes</h3>
        {bean.brew.notes?.length > 0 ? (
          <ul>
            {bean.brew.notes.map((note) => (
              <li>{note}</li>
            ))}
          </ul>
        ) : (
          <p>No brew notes logged for this cup.</p>
        )}
      </section>
    </div>
    <aside class="bean-side" aria-label="Bean support panes">
      <section class="window">
        {coffeeRows.length > 0 ? (
          <table class="cup-table">
            <caption>COFFEE</caption>
            <tbody>
              {coffeeRows.map((row) => (
                <tr>
                  <th scope="row">{row.label.toUpperCase()}</th>
                  <td>
                    {row.href ? <a href={row.href}>{row.value}</a> : row.value}
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        ) : (
          <p>No coffee details logged for this cup.</p>
        )}
      </section>
      <section class="window">
        {brewDetailsRows.length > 0 ? (
          <table class="cup-table">
            <caption>BREW DETAILS</caption>
            <tbody>
              {brewDetailsRows.map((row) => (
                <tr>
                  <th scope="row">
                    <span>{row.label.toUpperCase()}</span>
                    {row.definition && (
                      <details>
                        <summary aria-label={`Definition: ${row.label}`}>â“˜</summary>
                        <p>{row.definition}</p>
                      </details>
                    )}
                  </th>
                  <td>{row.href ? <a href={row.href}>{row.value}</a> : row.value}</td>
                </tr>
              ))}
            </tbody>
          </table>
        ) : (
          <p>No brew details logged for this cup.</p>
        )}
      </section>
      <section class="window">
        <h3 class="section-title">Gear</h3>
        {gearItems.length ? (
          <ul>
            {gearItems.map((item) => (
              <li>
                {item.label}:{" "}
                {item.slug ? (
                  <a href={withBase(`/equipment/${item.slug}/`)}>{item.value}</a>
                ) : (
                  item.value
                )}
              </li>
            ))}
          </ul>
        ) : (
          <p>No additional gear logged for this cup.</p>
        )}
      </section>
    </aside>
  </div>
</article>
