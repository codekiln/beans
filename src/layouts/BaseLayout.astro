---
import "../styles/global.css";
import { withBase } from "../utils/paths";

const {
  title = "Beans",
  description = "A coffee log.",
  initialCommand = "$ bean log 2026-01-25 bean1",
  initialLinkHref
} = Astro.props;

const beanPrefix = "$ bean";
const initialLog = initialCommand.startsWith(beanPrefix)
  ? initialCommand.slice(beanPrefix.length).trim()
  : initialCommand;
const resolvedLinkHref = initialLinkHref ?? withBase(Astro.url.pathname);
---
<!doctype html>
<html lang="en" data-theme="auto">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content={description} />
    <title>{title}</title>
    <link rel="alternate" type="application/rss+xml" title="Beans RSS" href={withBase("/rss.xml")} />
    <script>
      (() => {
        const root = document.documentElement;
        const storedTheme = localStorage.getItem("beans-theme");
        if (storedTheme === "light" || storedTheme === "dark") {
          root.dataset.theme = storedTheme;
          return;
        }
        const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
        root.dataset.theme = prefersDark ? "dark" : "light";
      })();
    </script>
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:ital,wght@0,400;0,600;1,400;1,600&family=Source+Serif+4:ital,wght@0,400;0,600;1,400;1,600&display=swap"
    />
  </head>
  <body>
    <a class="skip-link" href="#main">Skip to content</a>
    <header class="cli-float">
      <div class="cli-command-group" aria-label="Beans command">
        <a class="cli-command" data-cli-home href={withBase("/")}>$ bean</a>
        <a class="cli-command" data-cli-link href={resolvedLinkHref}>{initialLog}</a>
      </div>
      <button class="theme-toggle" type="button" data-theme-toggle aria-label="Toggle theme">
        <span aria-hidden="true">ðŸ«˜</span>
        <span class="theme-toggle-text sr-only">Theme</span>
      </button>
    </header>
    <main id="main" class="page-shell">
      <slot />
    </main>
    <footer class="page-shell footer">
      <p>$ beans Â· a coffee log rendered as a lab notebook.</p>
    </footer>
    <script>
      const root = document.documentElement;
      const storedTheme = localStorage.getItem("beans-theme");
      const media = window.matchMedia("(prefers-color-scheme: dark)");
      const applyTheme = (value) => {
        root.dataset.theme = value;
      };
      if (storedTheme) {
        applyTheme(storedTheme);
      } else {
        applyTheme(media.matches ? "dark" : "light");
      }
      const toggle = document.querySelector("[data-theme-toggle]");
      const toggleText = document.querySelector(".theme-toggle-text");
      if (toggle) {
        const updateLabel = () => {
          if (toggleText) {
            toggleText.textContent = root.dataset.theme === "dark" ? "Dark" : "Light";
          }
        };
        updateLabel();
        toggle.addEventListener("click", () => {
          const next = root.dataset.theme === "dark" ? "light" : "dark";
          applyTheme(next);
          localStorage.setItem("beans-theme", next);
          updateLabel();
        });
      }
      const commandLink = document.querySelector("[data-cli-link]");
      const entries = document.querySelectorAll("[data-cli-log]");
      if (commandLink && entries.length) {
        const observer = new IntersectionObserver(
          (items) => {
            const visible = items
              .filter((item) => item.isIntersecting)
              .sort((a, b) => b.intersectionRatio - a.intersectionRatio);
            if (visible[0]) {
              const { cliLog, cliHref } = visible[0].target.dataset;
              if (cliLog) {
                commandLink.textContent = cliLog;
              }
              if (cliHref) {
                commandLink.href = cliHref;
              }
            }
          },
          { rootMargin: "-30% 0px -60% 0px", threshold: [0.3, 0.6, 1] }
        );
        entries.forEach((entry) => observer.observe(entry));
      }
    </script>
  </body>
</html>
